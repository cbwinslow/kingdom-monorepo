name: Code Quality

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install complexity tools
        run: |
          pip install radon lizard mccabe
          npm install -g complexity-report

      - name: Analyze Python complexity
        run: |
          echo "## Python Complexity Report" >> complexity-report.md
          echo "" >> complexity-report.md
          radon cc . -a -nb >> complexity-report.md || true
          echo "" >> complexity-report.md
          echo "## Maintainability Index" >> complexity-report.md
          radon mi . >> complexity-report.md || true

      - name: Analyze JavaScript complexity
        run: |
          echo "" >> complexity-report.md
          echo "## JavaScript Complexity Report" >> complexity-report.md
          find . -name "*.js" -o -name "*.ts" | while read file; do
            cr "$file" || true
          done >> complexity-report.md

      - name: Post complexity report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('complexity-report.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: report
            });

  code-duplication:
    name: Code Duplication Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install duplication detector
        run: |
          pip install pylint
          npm install -g jscpd

      - name: Check Python duplication
        run: |
          echo "## Python Duplication Report" > duplication-report.md
          pylint --disable=all --enable=duplicate-code --output-format=text . >> duplication-report.md 2>&1 || echo "No significant duplication found" >> duplication-report.md

      - name: Check JavaScript duplication
        run: |
          echo "" >> duplication-report.md
          echo "## JavaScript Duplication Report" >> duplication-report.md
          jscpd . --format markdown >> duplication-report.md || echo "No significant duplication found" >> duplication-report.md

      - name: Upload duplication report
        uses: actions/upload-artifact@v4
        with:
          name: duplication-report
          path: duplication-report.md

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          npm ci || echo "No npm dependencies"
          pip install pytest pytest-cov coverage || echo "No Python dependencies"

      - name: Run tests with coverage
        run: |
          npm run test -- --coverage || true
          pytest --cov --cov-report=xml --cov-report=html || true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  dependency-graph:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Analyze dependencies
        run: |
          npm install -g depcheck madge
          
          echo "## Dependency Analysis" > dep-analysis.md
          echo "" >> dep-analysis.md
          echo "### Unused Dependencies" >> dep-analysis.md
          depcheck . || true >> dep-analysis.md
          
          echo "" >> dep-analysis.md
          echo "### Circular Dependencies" >> dep-analysis.md
          madge --circular --extensions js,ts . || echo "No circular dependencies found" >> dep-analysis.md

      - name: Upload dependency analysis
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: dep-analysis.md

  technical-debt:
    name: Technical Debt Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SonarQube Scanner
        uses: sonarsource/sonarqube-scan-action@master
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Analyze TODO/FIXME comments
        run: |
          echo "## Technical Debt Items" > tech-debt.md
          echo "" >> tech-debt.md
          echo "### TODO Comments" >> tech-debt.md
          grep -r "TODO" --include="*.js" --include="*.ts" --include="*.py" . || echo "None found" >> tech-debt.md
          echo "" >> tech-debt.md
          echo "### FIXME Comments" >> tech-debt.md
          grep -r "FIXME" --include="*.js" --include="*.ts" --include="*.py" . || echo "None found" >> tech-debt.md
          echo "" >> tech-debt.md
          echo "### HACK Comments" >> tech-debt.md
          grep -r "HACK" --include="*.js" --include="*.ts" --include="*.py" . || echo "None found" >> tech-debt.md

      - name: Upload tech debt report
        uses: actions/upload-artifact@v4
        with:
          name: technical-debt-report
          path: tech-debt.md

  quality-summary:
    name: Quality Summary
    if: always()
    needs: [complexity-analysis, code-duplication, code-coverage, dependency-graph, technical-debt]
    runs-on: ubuntu-latest
    steps:
      - name: Create quality summary
        run: |
          echo "## ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Complexity Analysis: ${{ needs.complexity-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Duplication Check: ${{ needs.code-duplication.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Coverage: ${{ needs.code-coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Analysis: ${{ needs.dependency-graph.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Technical Debt: ${{ needs.technical-debt.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
