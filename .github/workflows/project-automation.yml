name: Project Automation

on:
  issues:
    types: [opened, edited, labeled, assigned, closed]
  pull_request:
    types: [opened, edited, labeled, assigned, closed, merged]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  add-to-project:
    name: Add to Project Board
    runs-on: ubuntu-latest
    steps:
      - name: Add issue/PR to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/${{ github.repository_owner }}/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}

  update-project-status:
    name: Update Project Status
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'pull_request'
    steps:
      - name: Update status based on labels
        uses: actions/github-script@v7
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            
            let status = 'Todo';
            if (item.assignees.length > 0) {
              status = 'In Progress';
            }
            if (item.labels.some(l => l.name === 'in-review')) {
              status = 'In Review';
            }
            if (item.state === 'closed') {
              status = 'Done';
            }
            
            console.log(`Status: ${status}`);

  link-issues:
    name: Auto-link Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Link related issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Extract issue references (e.g., #123, fixes #456)
            const issueRefs = body.match(/#\d+/g) || [];
            const fixesRefs = body.match(/(?:fixes|closes|resolves)\s+#\d+/gi) || [];
            
            console.log('Found issue references:', issueRefs);
            console.log('Found fixes references:', fixesRefs);
            
            // Add comment linking issues
            if (issueRefs.length > 0) {
              const comment = `## ðŸ”— Linked Issues\n\nThis PR references: ${issueRefs.join(', ')}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }

  auto-create-issue-from-todo:
    name: Create Issues from TODOs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for TODOs
        uses: ribtoks/tdg-github-action@master
        with:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha }}

  assign-reviewers:
    name: Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Assign reviewers based on CODEOWNERS
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Define reviewers based on changed files
            const reviewers = ['cbwinslow']; // Add your reviewers here
            
            if (reviewers.length > 0) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: reviewers
              });
            }

  update-pr-description:
    name: Update PR Description
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Get commit messages
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const commitMessages = commits.map(c => `- ${c.commit.message}`).join('\n');
            
            const description = `## Changes\n\n${commitMessages}\n\n## Checklist\n- [ ] Tests added/updated\n- [ ] Documentation updated\n- [ ] Code reviewed\n- [ ] CI passing`;
            
            if (!pr.body || pr.body.length < 10) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: description
              });
            }

  stale-items:
    name: Handle Stale Items
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Mark stale issues and PRs
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: 'This issue has been automatically marked as stale because it has not had recent activity.'
          stale-pr-message: 'This PR has been automatically marked as stale because it has not had recent activity.'
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          days-before-stale: 30
          days-before-close: 7
