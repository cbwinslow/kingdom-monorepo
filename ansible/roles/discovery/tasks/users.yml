---
# User and group discovery tasks
- name: Get user list
  shell: getent passwd | awk -F: '{print $1":"$3":"$4":"$5":"$6":"$7}'
  register: user_list
  changed_when: false

- name: Get group list
  shell: getent group | awk -F: '{print $1":"$3}'
  register: group_list
  changed_when: false

- name: Get sudoers configuration
  shell: cat /etc/sudoers 2>/dev/null && find /etc/sudoers.d/ -type f -exec echo "=== {} ===" \; -exec cat {} \; 2>/dev/null || echo "No sudoers access"
  register: sudoers_config
  changed_when: false
  failed_when: false

- name: Get user home directories
  shell: ls -la /home/
  register: home_dirs
  changed_when: false
  failed_when: false

- name: Get shadow password info (hashed)
  shell: cat /etc/shadow
  register: shadow_info
  changed_when: false
  failed_when: false
  no_log: true

- name: Get login.defs
  shell: cat /etc/login.defs
  register: login_defs
  changed_when: false
  failed_when: false

- name: Get user login history
  shell: last -n 50
  register: login_history
  changed_when: false
  failed_when: false

- name: Save user and group information
  copy:
    content: |
      Users:
      {{ user_list.stdout }}
      
      Groups:
      {{ group_list.stdout }}
      
      Sudoers Configuration:
      {{ sudoers_config.stdout | default('N/A') }}
      
      Home Directories:
      {{ home_dirs.stdout | default('N/A') }}
      
      Shadow File (hashed passwords):
      {{ shadow_info.stdout | default('N/A') }}
      
      Login Definitions:
      {{ login_defs.stdout | default('N/A') }}
      
      Recent Login History:
      {{ login_history.stdout | default('N/A') }}
    dest: "{{ output_path }}/users_groups.txt"
  delegate_to: localhost
  become: false
